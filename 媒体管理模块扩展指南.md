# 若依管理系统 - 媒体管理模块扩展指南

## 概述

本扩展为若依管理系统添加了完整的音视频媒体管理功能，专门为iOS应用提供后端支持。该扩展采用最小化改动原则，不影响原有系统功能。

## 扩展内容

### 1. 新增模块结构

```
ruoyi-media/                    # 新增媒体管理模块
├── src/main/java/com/ruoyi/media/
│   ├── domain/                 # 实体类
│   │   ├── MediaFile.java      # 媒体文件实体
│   │   ├── MediaCategory.java  # 媒体分类实体
│   │   └── ...
│   ├── mapper/                 # 数据访问层
│   │   ├── MediaFileMapper.java
│   │   └── ...
│   └── service/                # 业务逻辑层
│       ├── IMediaFileService.java
│       └── ...
└── pom.xml                     # 模块依赖配置
```

### 2. 数据库扩展

新增5个数据表：
- `media_category` - 媒体分类表
- `media_file` - 媒体文件表
- `media_play_record` - 播放记录表
- `media_favorite` - 收藏表
- `media_comment` - 评论表

### 3. API接口

#### 管理后台接口 (`/media/file/`)
- 完整的CRUD操作
- 文件上传管理
- 权限控制

#### iOS应用接口 (`/api/media/`)
- 公开媒体文件列表
- 媒体文件详情
- 播放统计
- 点赞功能
- 文件上传

## 部署步骤

### 1. 数据库初始化

```sql
-- 执行媒体管理相关表创建
source sql/media_tables.sql;

-- 执行菜单权限初始化
source sql/media_menu.sql;
```

### 2. 编译部署

```bash
# 重新编译项目
mvn clean package -Dmaven.test.skip=true

# 启动后端服务
java -jar ruoyi-admin/target/ruoyi-admin.jar
```

### 3. 前端配置

在 `ruoyi-ui` 中需要添加对应的前端页面（可选，主要为iOS应用提供API）。

## iOS应用集成

### 1. 主要API端点

```
基础URL: http://your-domain:8080/api/media

GET  /public/list              # 获取公开媒体列表
GET  /public/{fileId}          # 获取媒体详情
POST /play/{fileId}            # 播放媒体（统计）
POST /like/{fileId}            # 点赞媒体
GET  /category/{categoryId}    # 按分类获取媒体
POST /upload                   # 上传媒体文件
```

### 2. 请求示例

#### 获取媒体列表
```http
GET /api/media/public/list?fileType=video&pageNum=1&pageSize=10
```

#### 上传媒体文件
```http
POST /api/media/upload
Content-Type: multipart/form-data

file: [媒体文件]
title: "视频标题"
description: "视频描述"
categoryId: 1
tags: "标签1,标签2"
```

### 3. 响应格式

```json
{
    "code": 200,
    "msg": "操作成功",
    "data": {
        "fileId": 1,
        "title": "示例视频",
        "fileUrl": "http://domain/upload/2025/01/01/video_123.mp4",
        "thumbnailUrl": "http://domain/upload/2025/01/01/thumb_123.jpg",
        "duration": 120,
        "viewCount": 100,
        "likeCount": 50
    }
}
```

## 功能特性

### 1. 文件管理
- 支持多种音视频格式（mp3, mp4, avi, mov等）
- 自动生成缩略图（视频）
- 文件大小和时长记录
- 分类管理

### 2. 统计功能
- 播放次数统计
- 点赞数统计
- 播放记录追踪
- 用户行为分析

### 3. 权限控制
- 公开/私有文件设置
- 状态管理（正常/停用/审核中）
- 基于角色的权限控制

### 4. iOS应用支持
- RESTful API设计
- 分页查询支持
- 设备ID追踪
- 无需登录的公开接口

## 配置说明

### 1. 文件存储配置

在 `application.yml` 中配置：

```yaml
ruoyi:
  # 文件上传路径
  profile: ./uploadPath
  # 媒体文件专用路径
  mediaPath: ./uploadPath/media
```

### 2. 支持的文件格式

音频格式：mp3, wav, wma, aac, flac, ogg, m4a
视频格式：mp4, avi, rmvb, wmv, mov, flv, mkv, webm, m4v

### 3. 文件大小限制

默认支持最大50MB文件，可在配置中调整：

```yaml
spring:
  servlet:
    multipart:
      max-file-size: 100MB
      max-request-size: 100MB
```

## 扩展建议

### 1. 缩略图生成
可集成FFmpeg实现视频缩略图自动生成：

```java
// 示例：使用FFmpeg生成视频缩略图
public String generateThumbnail(String videoPath) {
    // FFmpeg命令实现
}
```

### 2. 云存储集成
支持阿里云OSS、腾讯云COS等：

```java
// 示例：云存储上传
public String uploadToCloud(MultipartFile file) {
    // 云存储API调用
}
```

### 3. 转码服务
集成音视频转码服务，支持格式转换。

### 4. CDN加速
配置CDN加速媒体文件访问。

## 注意事项

1. **性能考虑**：大文件上传需要考虑服务器性能和网络带宽
2. **存储空间**：音视频文件占用空间较大，需要合理规划存储
3. **安全性**：上传接口建议增加认证机制
4. **备份策略**：重要媒体文件需要定期备份

## 技术支持

如有问题，请参考：
1. 若依官方文档：http://doc.ruoyi.vip
2. 本扩展源码注释
3. 数据库表结构说明

---

**版本**: v1.0  
**更新时间**: 2025年1月  
**兼容性**: 若依管理系统 v3.9.0 